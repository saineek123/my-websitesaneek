<!-- FINAL: color_game.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Color Game</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { font-family: 'Poppins', sans-serif; background: #111; color: white; text-align: center; }
    .wallet { background: #222; padding: 10px; display: flex; justify-content: space-between; }
    .wallet span { color: yellow; }
    button { padding: 10px 20px; margin: 10px; border-radius: 6px; font-size: 16px; border: none; }
    .red { background: red; color: white; }
    .black { background: black; color: white; }
    .violet { background: purple; color: white; }
    #resultBox { font-size: 24px; margin-top: 20px; }
    .popup { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); padding:20px; border-radius:10px; z-index:999; font-weight:bold; }
    .win { background: #00ffcc; color: black; }
    .lose { background: #ffcccc; color: black; }
  </style>
</head>
<body>
  <div class="wallet">
    Wallet: ‚Çπ<span id="wallet">0</span>
    <div>
      <a href="recharge.html"><button>Deposit</button></a>
      <a href="withdraw.html"><button>Withdraw</button></a>
    </div>
  </div>

  <h2>üéØ Color Betting Game</h2>
  <div>‚è≥ Time left: <span id="timer">--</span>s</div>
  <div>Period: <span id="periodId">--</span></div>
  
  <div>
    <input type="number" id="amount" placeholder="Enter Amount ‚Çπ" />
    <button class="red" onclick="placeBet('red')">Red</button>
    <button class="black" onclick="placeBet('black')">Black</button>
    <button class="violet" onclick="placeBet('violet')">Violet</button>
  </div>

  <div id="userBetsBox"></div>
  <div id="resultBox"></div>
  <div id="historyBox"></div>
  <div id="popupBox"></div>

  <script>
    const config = {
      apiKey: "AIzaSyDTIIz6F0Dpxow48HiIyhn1qCISHcdubiQ",
      authDomain: "betting-app-43800.firebaseapp.com",
      databaseURL: "https://betting-app-43800-default-rtdb.firebaseio.com",
      projectId: "betting-app-43800"
    };
    firebase.initializeApp(config);
    const db = firebase.database();

    let userId = localStorage.getItem("userId") || "user_" + Math.floor(Math.random() * 10000);
    localStorage.setItem("userId", userId);
    let balance = 0;
    let currentBet = null, currentMatchId = null, history = [];

    function updateWallet() {
      db.ref("users/" + userId + "/wallet").on("value", snap => {
        balance = snap.val() || 0;
        document.getElementById("wallet").innerText = balance.toFixed(2);
      });
    }

    function placeBet(color) {
      const amt = parseFloat(document.getElementById("amount").value);
      if (!amt || amt <= 0 || amt > balance || !currentMatchId) return alert("Invalid or insufficient balance!");

      currentBet = { color, amount: amt };
      db.ref("users/" + userId + "/wallet").transaction(val => (val || 0) - amt);
      db.ref("colorGame/matches/" + currentMatchId + "/bets/" + userId).set(currentBet);
      document.getElementById("userBetsBox").innerText = `You bet ‚Çπ${amt} on ${color.toUpperCase()}`;
    }

    function showPopup(msg, type) {
      const box = document.getElementById("popupBox");
      box.innerHTML = `<div class="popup ${type}">${msg}</div>`;
      setTimeout(() => box.innerHTML = '', 3000);
    }

    function showResult(result) {
      document.getElementById("resultBox").innerText = `üéØ RESULT: ${result.toUpperCase()}`;
      if (currentBet) {
        if (currentBet.color === result) {
          let winAmt = result === "violet" ? currentBet.amount * 5 : currentBet.amount * 2;
          db.ref("users/" + userId + "/wallet").transaction(val => (val || 0) + winAmt);
          showPopup("üéâ You won ‚Çπ" + winAmt.toFixed(2), 'win');
        } else {
          showPopup("üòû You lost!", 'lose');
        }
        currentBet = null;
      }
    }

    db.ref("colorGame/currentMatchId").on("value", snap => {
      const matchId = snap.val();
      if (!matchId) return;
      currentMatchId = matchId;
      document.getElementById("periodId").innerText = matchId;

      db.ref("colorGame/matches/" + matchId + "/startTime").once("value").then(snap => {
        const startTime = snap.val();
        if (!startTime) return;

        const timerEl = document.getElementById("timer");
        let timer = setInterval(() => {
          const left = Math.max(0, 30 - Math.floor((Date.now() - startTime) / 1000));
          timerEl.innerText = left;
          if (left === 0) clearInterval(timer);
        }, 1000);
      });

      // Listen for result
      db.ref("colorGame/matches/" + matchId + "/result").on("value", snap => {
        const result = snap.val();
        if (!result) return;
        showResult(result);
        history.unshift({ matchId, result });
        if (history.length > 10) history.pop();

        document.getElementById("historyBox").innerHTML = `
          <div><b>History:</b> ${history.map(h => `<span>${h.result}</span>`).join(' | ')}</div>
          <div><b>Periods:</b> ${history.map(h => `<span>${h.matchId}</span>`).join(' | ')}</div>
        `;
      });
    });

    updateWallet();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Color Betting Game</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { margin: 0; font-family: 'Poppins', sans-serif; background: #111; color: #fff; }
    .wallet { display: flex; flex-direction: column; align-items: center; padding: 10px 15px; background: #222; }
    .wallet span { color: yellow; font-weight: bold; }
    .wallet .breakdown { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-top: 8px; }
    .wallet .box { background: #333; padding: 8px 12px; border-radius: 6px; font-size: 14px; }
    .wallet .box b { color: #0ff; }
    .wallet .actions { margin-top: 8px; }
    .wallet .actions button { margin: 0 5px; padding: 5px 10px; border: none; border-radius: 6px; background: #0ff; color: #000; font-weight: bold; }

    .header { text-align: center; padding: 15px 0; font-size: 24px; background: #000; color: #0ff; }
    .container { padding: 15px; text-align: center; }
    .container input, .container button { width: 90%; max-width: 300px; margin: 10px auto; padding: 10px; font-size: 16px; border-radius: 6px; border: none; }
    .color-btns button { width: 30%; margin: 1%; font-size: 18px; font-weight: bold; }
    .red { background: red; color: white; }
    .black { background: black; color: white; }
    .violet { background: purple; color: white; }
    .info { margin-top: 10px; font-size: 16px; }
    .history { margin-top: 20px; font-size: 14px; color: #ccc; }
    .popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; border-radius: 10px; z-index: 999; font-weight: bold; text-align: center; }
    .win { background: #00ffcc; color: black; }
    .lose { background: #ffcccc; color: black; }
  </style>
</head>
<body>
  <div class="wallet">
    <div>Total Wallet: ‚Çπ<span id="wallet">0</span></div>
    <div class="breakdown">
      <div class="box">Recharge: ‚Çπ<b id="recharge">0</b></div>
      <div class="box">Bonus: ‚Çπ<b id="bonus">0</b></div>
      <div class="box">Winning: ‚Çπ<b id="winning">0</b></div>
    </div>
    <div class="actions">
      <a href="recharge.html"><button>Deposit</button></a>
      <a href="withdraw.html"><button>Withdraw</button></a>
    </div>
  </div>

  <div class="header">üéØ Color Betting Game</div>

  <div class="container">
    <div class="info">
      Period: <span id="periodId">--</span><br>
      ‚è≥ Time left: <span id="timer">--</span>s
    </div>

    <input type="number" id="amount" placeholder="Enter Amount ‚Çπ" />

    <div class="color-btns">
      <button class="red" onclick="placeBet('red')">RED</button>
      <button class="black" onclick="placeBet('black')">BLACK</button>
      <button class="violet" onclick="placeBet('violet')">VIOLET</button>
    </div>

    <div id="userBetsBox" class="info"></div>
    <div id="resultBox" class="info" style="font-size: 20px; margin-top: 10px;"></div>
    <div id="historyBox" class="history"></div>
  </div>

  <div id="popupBox"></div>

  <script>
    const config = {
      apiKey: "AIzaSyDTIIz6F0Dpxow48HiIyhn1qCISHcdubiQ",
      authDomain: "betting-app-43800.firebaseapp.com",
      databaseURL: "https://betting-app-43800-default-rtdb.firebaseio.com",
      projectId: "betting-app-43800"
    };
    firebase.initializeApp(config);
    const db = firebase.database();

    const userId = localStorage.getItem("userId");
    if (!userId) window.location.href = "login.html";

    let balance = 0;
    let currentBet = null, currentMatchId = null, history = [];

    function updateWallet() {
      const path = "users/" + userId + "/walletBreakup";
      db.ref(path).on("value", (snap) => {
        const data = snap.val() || {};
        const recharge = parseFloat(data.recharge) || 0;
        const bonus = parseFloat(data.bonus) || 0;
        const winning = parseFloat(data.winning) || 0;

        const total = recharge + bonus + winning;

        document.getElementById("wallet").innerText = total.toFixed(2);
        document.getElementById("recharge").innerText = recharge.toFixed(2);
        document.getElementById("bonus").innerText = bonus.toFixed(2);
        document.getElementById("winning").innerText = winning.toFixed(2);

        balance = total;
      });
    }

    function placeBet(color) {
      const amt = parseFloat(document.getElementById("amount").value);
      if (!amt || amt <= 0 || amt > balance || !currentMatchId) return alert("Invalid or insufficient balance!");

      currentBet = { color, amount: amt };
      db.ref("users/" + userId + "/walletBreakup/winning").transaction(w => (w || 0) - amt);
      db.ref("colorGame/matches/" + currentMatchId + "/bets/" + userId).set(currentBet);
      document.getElementById("userBetsBox").innerText = `You bet ‚Çπ${amt} on ${color.toUpperCase()}`;
    }

    function showPopup(msg, type) {
      const box = document.getElementById("popupBox");
      box.innerHTML = `<div class="popup ${type}">${msg}</div>`;
      setTimeout(() => box.innerHTML = '', 3000);
    }

    function showResult(result) {
      document.getElementById("resultBox").innerText = `üéØ RESULT: ${result.toUpperCase()}`;
      if (currentBet) {
        if (currentBet.color === result) {
          let winAmt = result === "violet" ? currentBet.amount * 5 : currentBet.amount * 2;
          db.ref("users/" + userId + "/walletBreakup/winning").transaction(w => (w || 0) + winAmt);
          showPopup("üéâ You won ‚Çπ" + winAmt.toFixed(2), 'win');
        } else {
          showPopup("üòû You lost!", 'lose');
        }
        currentBet = null;
      }
    }

    db.ref("colorGame/currentMatchId").on("value", snap => {
      const matchId = snap.val();
      if (!matchId) return;
      currentMatchId = matchId;
      document.getElementById("periodId").innerText = matchId;
      document.getElementById("resultBox").innerText = "";
      document.getElementById("userBetsBox").innerText = "";

      db.ref("colorGame/matches/" + matchId + "/startTime").once("value").then(snap => {
        const startTime = snap.val();
        if (!startTime) return;

        const timerEl = document.getElementById("timer");
        clearInterval(window.timerInterval);
        const updateTimer = () => {
          const left = Math.max(0, 30 - Math.floor((Date.now() - startTime) / 1000));
          timerEl.innerText = left;
          if (left <= 0) clearInterval(window.timerInterval);
        };
        updateTimer();
        window.timerInterval = setInterval(updateTimer, 1000);
      });

      db.ref("colorGame/matches/" + matchId + "/result").on("value", snap => {
        const result = snap.val();
        if (!result) return;
        showResult(result);
        history.unshift({ matchId, result });
        if (history.length > 10) history.pop();

        document.getElementById("historyBox").innerHTML = `
          <div><b>History:</b> ${history.map(h => `<span>${h.result}</span>`).join(' | ')}</div>
          <div><b>Periods:</b> ${history.map(h => `<span>${h.matchId}</span>`).join(' | ')}</div>
        `;
      });
    });

    updateWallet();
  </script>
</body>
</html>

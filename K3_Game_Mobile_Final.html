<!-- Firebase SDK v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDTIIz6F0Dpxow48HiIyhn1qCISHcdubiQ",
    authDomain: "betting-app-43800.firebaseapp.com",
    databaseURL: "https://betting-app-43800-default-rtdb.firebaseio.com",
    projectId: "betting-app-43800"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();

  let userId = null;
  let currentBets = [];
  let currentMatchId = null;
  let lastProcessedMatch = null;
  let timerInterval = null;
  let roundEnded = false;

  // âœ… Same UID in localStorage
  userId = localStorage.getItem("userId");

  if (!userId) {
    auth.signInAnonymously().then(() => {
      auth.onAuthStateChanged(user => {
        if (user) {
          userId = user.uid;
          localStorage.setItem("userId", userId);
          initWallet();
          startGame();
        }
      });
    }).catch(console.error);
  } else {
    initWallet();
    startGame();
  }

  function initWallet() {
    const walletRef = db.ref(`users/${userId}/wallet`);
    walletRef.once("value").then(snap => {
      if (!snap.exists()) {
        walletRef.set({ recharge: 1000, bonus: 100, winning: 0 });
      }
    });
    walletRef.on("value", snap => {
      const w = snap.val() || {};
      const recharge = w.recharge || 0;
      const bonus = w.bonus || 0;
      const winning = w.winning || 0;
      const total = recharge + bonus + winning;
      document.getElementById("wallet").innerText = total.toFixed(2);
      document.getElementById("rechargeBalance").innerText = recharge.toFixed(2);
      document.getElementById("bonusBalance").innerText = bonus.toFixed(2);
      document.getElementById("winningBalance").innerText = winning.toFixed(2);
      document.getElementById("totalBalance").innerText = total.toFixed(2);
    });
  }

  function startGame() {
    db.ref("k3game/currentMatchId").on("value", snap => {
      const id = snap.val();
      if (id && id !== currentMatchId) {
        currentMatchId = id;
        roundEnded = false;
        currentBets = [];
        lastProcessedMatch = null;
        document.getElementById("periodId").innerText = id;
        document.getElementById("resultDisplay").style.display = "none";
        document.getElementById("userBetsBox").innerHTML = "";
      }
    });

    db.ref("k3game/currentMatchStartTime").on("value", snap => {
      const start = snap.val();
      if (!start) return;
      const elapsed = Math.floor((Date.now() - start) / 1000);
      const left = 30 - elapsed;
      if (left > 0) runTimer(left);
    });

    db.ref("k3game/matches").on("value", snap => {
      const matches = snap.val() || {};
      const match = matches[currentMatchId];
      if (match && match.result && lastProcessedMatch !== currentMatchId) {
        lastProcessedMatch = currentMatchId;
        stopDice(match.result.dice1, match.result.dice2, match.result.dice3);
      }
    });

    loadHistory();
  }

  function runTimer(sec) {
    clearInterval(timerInterval);
    document.getElementById("timer").innerText = `${sec}s`;
    timerInterval = setInterval(() => {
      sec--;
      document.getElementById("timer").innerText = `${sec}s`;
      if (sec <= 0) {
        clearInterval(timerInterval);
        roundEnded = true;
        rollDiceAnim();
      }
    }, 1000);
  }

  const dots = {
    1: [0,0,0,0,1,0,0,0,0],
    2: [1,0,0,0,0,0,0,0,1],
    3: [1,0,0,0,1,0,0,0,1],
    4: [1,0,1,0,0,0,1,0,1],
    5: [1,0,1,0,1,0,1,0,1],
    6: [1,0,1,1,0,1,1,0,1],
  };

  function showDice(id, num) {
    const dice = document.getElementById(id);
    dice.innerHTML = "";
    dots[num].forEach(v => {
      const dot = document.createElement("div");
      dot.className = v ? "dot" : "dot hidden";
      dice.appendChild(dot);
    });
  }

  function rollDiceAnim() {
    ["dice1","dice2","dice3"].forEach(id => {
      const d = document.getElementById(id);
      d.classList.add("dice-rolling");
      showDice(id, Math.ceil(Math.random()*6));
    });
  }

  function stopDice(d1, d2, d3) {
    ["dice1","dice2","dice3"].forEach(id => {
      const d = document.getElementById(id);
      d.classList.remove("dice-rolling");
    });
    showDice("dice1", d1);
    showDice("dice2", d2);
    showDice("dice3", d3);

    const sum = d1 + d2 + d3;
    document.getElementById("diceResult").innerText = `${d1} + ${d2} + ${d3} = ${sum}`;
    document.getElementById("resultDisplay").style.display = "block";
    payout(sum);
  }

  function payout(sum) {
    let win = 0;
    currentBets.forEach(bet => {
      if (bet.type === "Big" && sum >= 11) win += bet.amount * 1.95;
      else if (bet.type === "Small" && sum <= 10) win += bet.amount * 1.95;
      else if (parseInt(bet.type) === sum) win += bet.amount * 6;
    });

    document.getElementById("payoutAmount").innerText = win.toFixed(2);
    document.getElementById("resultDisplay").className = "result-display " + (win ? "win":"lose");

    if (win) {
      const walletRef = db.ref(`users/${userId}/wallet`);
      walletRef.once("value").then(snap => {
        const w = snap.val() || {};
        w.winning = (w.winning || 0) + win;
        walletRef.set(w);
      });
      document.getElementById("winAmount").innerText = win.toFixed(2);
      document.getElementById("winPopup").style.display = "block";
    } else if (currentBets.length) {
      document.getElementById("losePopup").style.display = "block";
    }
  }

  function loadHistory() {
    db.ref("k3game/matches").orderByKey().limitToLast(10).on("value", snap => {
      const matches = snap.val() || {};
      const box = document.getElementById("historyBox");
      box.innerHTML = "";
      Object.entries(matches).reverse().forEach(([id, m]) => {
        if (!m.result) return;
        const sum = m.result.dice1 + m.result.dice2 + m.result.dice3;
        const item = `<div class="history-item">ðŸŽ² ${m.result.dice1}-${m.result.dice2}-${m.result.dice3} = ${sum}</div>`;
        box.innerHTML += item;
      });
    });
  }

  const betOpt = ["Big","Small","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18"];
  let selectedBet = null;
  const betBox = document.getElementById("betButtons");
  betOpt.forEach(opt => {
    const b = document.createElement("button");
    b.className = "bet-btn";
    b.innerText = opt;
    b.onclick = () => {
      selectedBet = opt;
      document.querySelectorAll(".bet-btn").forEach(bx => bx.classList.remove("active"));
      b.classList.add("active");
    };
    betBox.appendChild(b);
  });

  function setAmt(a) {
    document.getElementById("amount").value = a;
  }

  function placeBet() {
    const amt = parseFloat(document.getElementById("amount").value);
    if (!amt || amt <= 0) return alert("Enter valid amount!");
    if (!selectedBet) return alert("Select bet!");
    if (roundEnded) return alert("Round ended, wait next!");
    if (!currentMatchId) return alert("No match!");

    const walletRef = db.ref(`users/${userId}/wallet`);
    walletRef.once("value").then(snap => {
      const w = snap.val() || {};
      let total = (w.recharge || 0) + (w.bonus || 0) + (w.winning || 0);
      if (total < amt) return alert("Low balance!");

      let rem = amt;
      if (w.recharge >= rem) w.recharge -= rem;
      else {
        rem -= w.recharge; w.recharge = 0;
        if (w.bonus >= rem) w.bonus -= rem;
        else {
          rem -= w.bonus; w.bonus = 0;
          w.winning -= rem;
        }
      }
      walletRef.set(w);

      db.ref(`k3game/matches/${currentMatchId}/bets/${userId}/${selectedBet}`).set({ amount: amt });
      const chip = `<div class="bet-chip"><i class="fas fa-coins"></i> ${selectedBet} - â‚¹${amt}</div>`;
      document.getElementById("userBetsBox").innerHTML += chip;

      currentBets.push({ type: selectedBet, amount: amt });
      document.getElementById("amount").value = "";
    });
  }

  showDice("dice1", 1); showDice("dice2", 2); showDice("dice3", 3);
</script>

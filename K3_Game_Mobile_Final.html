<!-- FINAL: k3.html - With Result Fix and Full Features + Wallet Breakdown -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>K3 Game Final</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #f857a6, #ff5858); margin:0; color:white; }
    .header { text-align:center; padding:16px; font-size:22px; font-weight:bold; background: rgba(0,0,0,0.2); }
    .wallet { padding:12px 16px; background: rgba(255,255,255,0.1); font-size:16px; }
    .wallet-row { display: flex; justify-content: space-between; align-items: center; }
    .wallet span { font-weight:bold; color:#ffff00; }
    .wallet-breakdown { font-size: 14px; margin-top: 6px; color: #fff; }
    .wallet button { background:#00e0ff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
    .container { max-width: 420px; margin:auto; padding: 20px; }
    .dice { text-align:center; font-size:60px; margin:20px 0; }
    .bet-grid { display: flex; flex-wrap: wrap; justify-content:center; gap:8px; margin-bottom:16px; }
    .bet-grid button { padding:10px; min-width:70px; font-size:16px; border-radius:10px; border:none; background:white; color:#f857a6; font-weight:bold; cursor:pointer; }
    .bet-grid button.active { background:#f857a6; color:white; }
    .quick-buttons { display:flex; justify-content:center; gap:10px; margin-bottom:10px; }
    .quick-buttons button { background:#ffe600; border:none; border-radius:8px; padding:8px 14px; cursor:pointer; font-weight:bold; }
    input[type='number'], .place-bet { width:90%; margin:10px auto; display:block; padding:10px; border-radius:10px; font-size:16px; border:none; }
    .place-bet { background:#00ffab; font-weight:bold; cursor:pointer; }
    .user-bets, .result { text-align:center; margin-top:10px; }
    .user-bets span { background:white; color:black; padding:4px 10px; margin:2px; border-radius:8px; display:inline-block; }
    .history { margin-top:20px; text-align:center; }
    .history div { margin-bottom:10px; }
    .history span { background:white; color:black; padding:4px 10px; margin:2px; border-radius:8px; display:inline-block; }
    .popup { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; color:black; padding:20px; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,0.3); text-align:center; z-index:999; }
    .popup.win { background:#00ffcc; }
    .popup.lose { background:#ffcccc; }
  </style>
</head>
<body>
  <div class="header">üé≤ K3 Dice Game</div>
  <div class="wallet">
    <div class="wallet-row">
      Wallet: ‚Çπ<span id="wallet">0</span>
      <div>
        <a href="recharge.html"><button>Deposit</button></a>
        <a href="withdraw.html"><button>Withdraw</button></a>
      </div>
    </div>
    <div class="wallet-breakdown">
      Recharge: ‚Çπ<span id="rechargeBalance">0</span> |
      Bonus: ‚Çπ<span id="bonusBalance">0</span> |
      Winning: ‚Çπ<span id="winningBalance">0</span> |
      Total: ‚Çπ<span id="totalBalance">0</span>
    </div>
  </div>
  <div class="container">
    <div style="text-align:center;">‚è≥ Time left: <span id="timer">--</span>s</div>
    <div style="text-align:center;">Period: <span id="periodId"></span></div>
    <div class="dice" id="diceBox">üé≤ üé≤ üé≤</div>
    <div class="bet-grid" id="betButtons"></div>
    <div class="quick-buttons">
      <button onclick="setAmt(10)">‚Çπ10</button>
      <button onclick="setAmt(50)">‚Çπ50</button>
      <button onclick="setAmt(100)">‚Çπ100</button>
      <button onclick="setAmt(500)">‚Çπ500</button>
    </div>
    <input type="number" id="amount" placeholder="Enter Amount ‚Çπ" />
    <button class="place-bet" onclick="placeBet()">Place Bet</button>
    <div class="user-bets" id="userBetsBox"></div>
    <div class="result" id="resultBox"></div>
    <div class="history" id="historyBox"></div>
  </div>
  <div id="popupBox"></div>

 <script>
  const firebaseConfig = {
    apiKey: "AIzaSyDTIIz6F0Dpxow48HiIyhn1qCISHcdubiQ",
    authDomain: "betting-app-43800.firebaseapp.com",
    databaseURL: "https://betting-app-43800-default-rtdb.firebaseio.com",
    projectId: "betting-app-43800"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const userId = localStorage.getItem("userId") || "guest";

  const updateWallet = () => {
    db.ref("users/" + userId).on("value", snap => {
      const data = snap.val() || {};
      const recharge = data.recharge || 0;
      const bonus = data.bonus || 0;
      const winning = data.winning || 0;
      const total = recharge + bonus + winning;

      document.getElementById("wallet").innerText = total.toFixed(2);
      document.getElementById("rechargeBalance").innerText = recharge;
      document.getElementById("bonusBalance").innerText = bonus;
      document.getElementById("winningBalance").innerText = winning;
      document.getElementById("totalBalance").innerText = total;
    });
  };

  updateWallet();

  let currentMatchId = null;
  let startTime = null;
  let timerInterval;

  function startTimer(secondsLeft) {
    clearInterval(timerInterval);
    document.getElementById("timer").innerText = secondsLeft;
    timerInterval = setInterval(() => {
      secondsLeft--;
      document.getElementById("timer").innerText = secondsLeft;
      if (secondsLeft <= 0) clearInterval(timerInterval);
    }, 1000);
  }

  function loadMatch() {
    db.ref("k3game/currentMatchId").on("value", snap => {
      currentMatchId = snap.val();
      document.getElementById("periodId").innerText = currentMatchId;
    });

    db.ref("k3game/currentMatchStartTime").on("value", snap => {
      const start = snap.val();
      if (!start) return;
      startTime = start;
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const remaining = 30 - elapsed;
      if (remaining > 0) startTimer(remaining);
    });

    db.ref("k3game/matches").on("value", snap => {
      const data = snap.val() || {};
      const match = data[currentMatchId];
      if (!match || !match.result) {
        document.getElementById("diceBox").innerText = "üé≤ üé≤ üé≤";
        document.getElementById("resultBox").innerText = "";
        return;
      }
      const { dice1, dice2, dice3 } = match.result;
      const total = dice1 + dice2 + dice3;
      document.getElementById("diceBox").innerText = `üé≤ ${dice1} üé≤ ${dice2} üé≤ ${dice3}`;
      document.getElementById("resultBox").innerText = `Result: ${total}`;
    });
  }

  function setAmt(amt) {
    document.getElementById("amount").value = amt;
  }

  function placeBet() {
    const betAmount = parseInt(document.getElementById("amount").value);
    if (!betAmount || betAmount <= 0) return alert("Enter valid amount");
    if (!currentMatchId) return alert("No active match");

    const betType = selectedBet;
    if (!betType) return alert("Select a bet");

    const betRef = db.ref(`k3game/matches/${currentMatchId}/bets/${userId}/${betType}`);
    betRef.set({ amount: betAmount });

    const userBetsBox = document.getElementById("userBetsBox");
    const span = document.createElement("span");
    span.innerText = `${betType} - ‚Çπ${betAmount}`;
    userBetsBox.appendChild(span);
  }

  let selectedBet = null;
  const betOptions = ["Big", "Small", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17"];
  const betButtonsBox = document.getElementById("betButtons");
  betOptions.forEach(option => {
    const btn = document.createElement("button");
    btn.innerText = option;
    btn.onclick = () => {
      selectedBet = option;
      document.querySelectorAll("#betButtons button").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    };
    betButtonsBox.appendChild(btn);
  });

  loadMatch();
</script>

</body>
</html>
